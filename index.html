<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping List</title>
</head>

<body>
  <!-- Google Translate -->
  <div id="google_translate_element"></div>

  <div id="shopping-list">
    <h2>Shopping List</h2>
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px;">
      <div class="saldo">
        <h5 class="balance">Loading...</h5>
      </div>
      <div id="total-price" class="total">Total cost: NT$0.00</div>
    </div>

    <!-- Tombol switch -->
    <div class="btn-group">
      <button id="show-products">All Products</button>
      <button id="show-saved">Saved Products</button>
    </div>

    <ul id="item-list" class="products"></ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const balanceElement = document.querySelector(".balance");
      const itemList = document.getElementById('item-list');
      const totalPrice = document.getElementById('total-price');

      // --- Balance ---
      async function fetchBalance() {
        try {
          const response = await fetch('https://www.eldjie.uk/api/saldo');
          const result = await response.json();
          if (response.ok) {
            const saldo = result.data.saldo !== undefined
              ? result.data.saldo
              : (result.data && result.data[0] && result.data[0].saldo) || 0;
            balanceElement.textContent = `Money balance: NT$ ${saldo}`;
          } else {
            balanceElement.textContent = 'Error fetching balance';
            console.error('Error fetching balance:', result.error);
          }
        } catch (error) {
          balanceElement.textContent = 'Error fetching balance';
          console.error('Network error:', error);
        }
      }

      fetchBalance();
      setInterval(fetchBalance, 60000); // refresh tiap 1 menit

      // --- Products (all/saved) ---
      async function fetchProducts(endpoint = 'https://www.eldjie.uk/api/products', type = "product") {
        try {
          const res = await fetch(endpoint);
          const data = await res.json();
          const items = Array.isArray(data[type]) ? data[type] : [];

          itemList.innerHTML = '';
          let total = 0;

          if (items.length === 0) {
            itemList.innerHTML = '<li>No products found</li>';
            totalPrice.textContent = 'Total: NT$0';
            return;
          }

          items.forEach(item => {
            const li = document.createElement("li");
            li.innerHTML = `
              <span style="flex:1;">${item.name}</span>
              <span style="flex:1; text-align:center; color:gray;">${formatDate(item.date)}</span>
              <span style="flex:1; text-align:right; color:red; font-weight:bold;">NT$${item.price}</span>
            `;
            itemList.appendChild(li);
            total += Number(item.price) || 0;
          });

          totalPrice.textContent = `Total cost: NT$${total.toLocaleString()}`;
        } catch (error) {
          console.error('Error updating item list:', error);
          itemList.innerHTML = '<li>Error fetching products</li>';
          totalPrice.textContent = 'Total: NT$0';
        }
      }

      function formatDate(date) {
        if (!date) return '-';
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      }

      // Default tampilkan all products
      fetchProducts();

      // Tombol switch
      document.getElementById("show-products").addEventListener("click", () => {
        fetchProducts('https://www.eldjie.uk/api/products', "product");
      });

      document.getElementById("show-saved").addEventListener("click", () => {
        fetchProducts('https://www.eldjie.uk/api/products/saved', "saved");
      });

      // Auto refresh product list tiap 10 detik
      setInterval(() => fetchProducts('https://www.eldjie.uk/api/products', "product"), 10000);
    });

    // Google Translate
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'id',
        includedLanguages: 'id,en',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>

</html>
