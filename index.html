<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping List</title>
</head>

<body>
  <div id="google_translate_element"></div>

  <div id="shopping-list">
    <h2>Shopping List</h2>
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px;">
      <div class="saldo"><h5 class="balance">Loading...</h5></div>
      <div id="total-price" class="total">Total cost: NT$0.00</div>
    </div>

    <div class="btn-group">
      <button id="show-products">All Products</button>
      <button id="show-saved">Saved Files</button>
    </div>

    <ul id="item-list" class="products"></ul>
  </div>

  <footer>
  <p style="text-align: center; font-size: 12px; color: #888; margin-top: 20px;">
    &copy; 2025 eldjie&rose. All rights reserved.
  </p>
</footer>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const balanceElement = document.querySelector(".balance");
      const itemList = document.getElementById('item-list');
      const totalPrice = document.getElementById('total-price');

      // --- Balance ---
      async function fetchBalance() {
        try {
          const res = await fetch('https://www.eldjie.uk/api/saldo');
          const result = await res.json();
          if (res.ok) {
            const saldo = result.data?.saldo ?? (result.data?.[0]?.saldo || 0);
            balanceElement.textContent = `Balance: NT$ ${saldo}`;
          } else {
            balanceElement.textContent = 'Error fetching balance';
          }
        } catch {
          balanceElement.textContent = 'Network error';
        }
      }
      fetchBalance();
      setInterval(fetchBalance, 60000);

      // --- All Products ---
      async function fetchProducts() {
        try {
          const res = await fetch('https://www.eldjie.uk/api/products');
          const result = await res.json();
          const items = Array.isArray(result.product) ? result.product : [];
          itemList.innerHTML = '';
          let total = 0;
          if (items.length === 0) {
            itemList.innerHTML = '<li>No products found</li>';
            totalPrice.textContent = 'Total: NT$0';
            return;
          }
          items.forEach(item => {
            const li = document.createElement("li");
            li.innerHTML = `
              <span>${item.name}</span>
              <span>${item.date}</span>
              <span style="color:red;">NT$${item.price}</span>`;
            itemList.appendChild(li);
            total += Number(item.price);
          });
          totalPrice.textContent = `Total: NT$${total}`;
        } catch {
          itemList.innerHTML = '<li>Error fetching products</li>';
          totalPrice.textContent = 'Total: NT$0';
        }
      }
      fetchProducts();
      setInterval(fetchProducts, 10000);

      // --- View Saved Files ---
      async function viewSavedFiles() {
        const modal = document.createElement("div");
        modal.classList.add("modal");
        modal.innerHTML = `
          <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Saved Files</h2>
            <ul class="savedFilesList">Loading...</ul>
          </div>`;
        document.body.appendChild(modal);

        const closeButton = modal.querySelector(".close-button");
        closeButton.addEventListener("click", () => modal.remove());

        const savedFilesList = modal.querySelector(".savedFilesList");
        try {
          const res = await fetch('https://www.eldjie.uk/api/products/saved');
          const result = await res.json();
          if (res.ok) {
            savedFilesList.innerHTML = "";
            result.files.forEach(file => {
              const li = document.createElement("li");
              li.innerHTML = `
                <span>${file.name}</span>
                <button class="viewfile" data-id="${file.id}">View</button>`;
              savedFilesList.appendChild(li);

              // View details
              li.querySelector(".viewfile").addEventListener("click", async () => {
                try {
                  const res = await fetch(`https://www.eldjie.uk/api/products/saved/${file.id}`);
                  const data = await res.json();
                  if (res.ok) {
                    const detailsModal = document.createElement("div");
                    detailsModal.classList.add("modal");
                    let content = `<div class="modal-content">
                      <span class="close-button">&times;</span>
                      <h3>File: ${data.file.name}</h3><ul>`;
                    data.file.data.forEach(item => {
                      content += `<li>
                        <span>${item.name}</span>
                        <span>${item.date}</span>
                        <span>NT$${item.price}</span>
                      </li>`;
                    });
                    content += "</ul></div>";
                    detailsModal.innerHTML = content;
                    document.body.appendChild(detailsModal);
                    detailsModal.querySelector(".close-button")
                      .addEventListener("click", () => detailsModal.remove());
                  }
                } catch {
                  alert("Error loading file details");
                }
              });
            });
          } else {
            savedFilesList.innerHTML = "<li>Error fetching saved files</li>";
          }
        } catch {
          savedFilesList.innerHTML = "<li>Network error</li>";
        }
      }

      // --- Button actions ---
      document.getElementById("show-products").addEventListener("click", fetchProducts);
      document.getElementById("show-saved").addEventListener("click", viewSavedFiles);
    });
  </script>

  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  <script>
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'id',
        includedLanguages: 'id,en',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
</body>
</html>
